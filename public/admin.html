<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ðŸ‘‘ Admin Panel - Proxy Shop</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .header { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 20px; background: #ddd; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: #667eea; color: white; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; border-bottom: 4px solid #667eea; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 15px; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .status-pending { color: #f39c12; font-weight: bold; }
        #loginSection { max-width: 400px; margin: 100px auto; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div id="loginSection" class="card">
    <h1>Connexion Admin</h1>
    <input type="email" id="adminEmail" placeholder="Email">
    <input type="password" id="adminPass" placeholder="Mot de passe">
    <button class="btn btn-success" style="width:100%" onclick="handleLogin()">Se connecter</button>
</div>

<div id="adminDashboard" class="container" style="display: none;">
    <div class="header">
        <h1>ðŸš€ Proxy Shop Admin</h1>
        <button class="btn btn-danger" onclick="logout()">DÃ©connexion</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><h3>Utilisateurs</h3><h2 id="statUsers">0</h2></div>
        <div class="stat-card"><h3>Revenu Total</h3><h2 id="statRevenue">$0.00</h2></div>
        <div class="stat-card"><h3>Proxies Actifs</h3><h2 id="statProxies">0</h2></div>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('users')">ðŸ‘¥ Utilisateurs</button>
        <button class="tab-btn" onclick="switchTab('recharges')">ðŸ’° Recharges</button>
    </div>

    <div id="usersTab" class="card">
        <h2>Gestion des Utilisateurs</h2>
        <table>
            <thead><tr><th>Email</th><th>Solde</th><th>Actions</th></tr></thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>

    <div id="rechargesTab" class="card" style="display: none;">
        <h2>Demandes de Recharge FaucetPay</h2>
        <table>
            <thead><tr><th>Email</th><th>Username FP</th><th>Montant</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="rechargeTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const API = ""; // URL automatique
    let token = localStorage.getItem('token');

    async function handleLogin() {
        const email = document.getElementById('adminEmail').value;
        const password = document.getElementById('adminPass').value;
        try {
            const res = await fetch(${API}/api/auth/login, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, password})
            });
            const data = await res.json();
            if (data.user?.isAdmin) {
                localStorage.setItem('token', data.token);
                location.reload();
            } else { alert("AccÃ¨s refusÃ©"); }
        } catch (e) { alert("Erreur connexion"); }
    }

    function logout() { localStorage.clear(); location.reload(); }

    function switchTab(tab) {
        document.getElementById('usersTab').style.display = tab === 'users' ? 'block' : 'none';
        document.getElementById('rechargesTab').style.display = tab === 'recharges' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    async function loadStats() {
        const res = await fetch(${API}/api/admin/stats, { headers: {'Authorization': `Bearer ${token}`} });
        const stats = await res.json();
        document.getElementById('statUsers').textContent = stats.totalUsers;
        document.getElementById('statRevenue').textContent = $${stats.totalRevenue.toFixed(2)};
    }

    async function loadUsers() {
        const res = await fetch(${API}/api/admin/users, { headers: {'Authorization': `Bearer ${token}`} });
        const users = await res.json();
        document.getElementById('userTableBody').innerHTML = users.map(u => `
            <tr>
                <td>${u.email}</td>
                <td><strong>$${u.balance.toFixed(2)}</strong></td>
                <td><button class="btn btn-success" onclick="addCredit('${u._id}')">+ CrÃ©dit</button></td>
            </tr>
        `).join('');
    }

    async function loadRecharges() {
        const res = await fetch(${API}/api/admin/recharges, { headers: {'Authorization': `Bearer ${token}`} });
        const requests = await res.json();
        document.getElementById('rechargeTableBody').innerHTML = requests.map(r => `
            <tr>
                <td>${r.userEmail}</td>
                <td>${r.faucetpayUsername}</td>
                <td>$${r.amount}</td>
                <td><span class="status-${r.status}">${r.status}</span></td>
                <td>
                    ${r.status === 'pending' ? `
                        <button class="btn btn-success" onclick="validateRecharge('${r._id}')">âœ”</button>
                        <button class="btn btn-danger" onclick="rejectRecharge('${r._id}')">âœ–</button>
                    ` : '-'}
                </td>
            </tr>
        `).join('');
    }

    async function validateRecharge(id) {
        await fetch(${API}/api/admin/recharges/validate, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
            body: JSON.stringify({id})
        });
        location.reload();
    }

    async function addCredit(userId) {
        const amount = prompt("Montant Ã  ajouter ($) :");
        if (!amount) return;
        await fetch(${API}/api/admin/add-credit, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
            body: JSON.stringify({userId, amount, description: 'Ajout Admin'})
        });
        loadUsers();
    }

    if (token) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        loadStats(); loadUsers(); loadRecharges();
    }
</script>
</body>
</html>
