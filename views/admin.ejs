<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Admin Panel ‚Äî ProxyFlow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
    --p:#6366f1;--p2:#8b5cf6;--p3:rgba(99,102,241,0.15);
    --bg:#0b0d14;--bg2:#111320;--bg3:#151928;
    --card:#171b2d;--card2:#1c2035;--card3:#212540;
    --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.04);
    --text:#f1f5f9;--muted:#64748b;--muted2:#475569;
    --success:#10b981;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6;
    --radius:14px;--radius-sm:8px;
}
html{scroll-behavior:smooth}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5;font-size:14px}
h1,h2,h3{font-weight:700;letter-spacing:-.02em}
input,textarea,select,button{font-family:inherit}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}

/* LOGIN */
#loginScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:radial-gradient(ellipse at 30% 20%,rgba(99,102,241,.15) 0%,transparent 60%),radial-gradient(ellipse at 70% 80%,rgba(139,92,246,.1) 0%,transparent 60%),var(--bg)}
.login-box{width:100%;max-width:420px;background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px 36px;box-shadow:0 40px 80px rgba(0,0,0,.6)}
.login-icon{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--p),var(--p2));display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 14px;box-shadow:0 8px 24px rgba(99,102,241,.4)}
.login-title{text-align:center;font-size:1.5rem;margin-bottom:4px}
.login-sub{text-align:center;color:var(--muted);font-size:.85rem;margin-bottom:28px}
.fg{display:flex;flex-direction:column;gap:6px;margin-bottom:18px}
.fl{font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.fi,.ft{background:rgba(255,255,255,.04);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--text);padding:11px 14px;font-size:.92rem;width:100%;outline:none;transition:border-color .2s,background .2s}
.fi:focus,.ft:focus{border-color:var(--p);background:rgba(99,102,241,.06)}
.fi::placeholder,.ft::placeholder{color:var(--muted2)}
.fi[readonly]{opacity:.6;cursor:default}
.ft{resize:vertical;min-height:90px;font-family:monospace;font-size:.82rem}
.btn-login{width:100%;padding:13px;border:none;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--p),var(--p2));color:white;font-size:.92rem;font-weight:700;cursor:pointer;transition:all .2s;box-shadow:0 4px 16px rgba(99,102,241,.35)}
.btn-login:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(99,102,241,.45)}

/* LAYOUT */
#dashboard{display:none;min-height:100vh}
.layout{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:240px;flex-shrink:0;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:200;transition:transform .3s ease;overflow-y:auto}
.sb-logo{padding:22px 20px 16px;display:flex;align-items:center;gap:11px;border-bottom:1px solid var(--border)}
.sb-logo-icon{width:36px;height:36px;border-radius:9px;flex-shrink:0;background:linear-gradient(135deg,var(--p),var(--p2));display:flex;align-items:center;justify-content:center;font-size:17px}
.sb-logo-text{font-size:1rem;font-weight:800;background:linear-gradient(135deg,#818cf8,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sb-logo-badge{font-size:.6rem;font-weight:700;background:rgba(99,102,241,.2);color:#a5b4fc;border-radius:4px;padding:1px 6px;-webkit-text-fill-color:#a5b4fc}
.sb-admin{padding:14px 20px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.sb-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--p2));display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:700;flex-shrink:0}
.sb-admin-info{min-width:0}
.sb-admin-label{font-size:.63rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.sb-admin-email{font-size:.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-nav{padding:12px 10px;flex:1}
.sb-sec-label{font-size:.62rem;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:.1em;padding:10px 10px 6px}
.nav-item{display:flex;align-items:center;gap:11px;padding:10px 12px;border-radius:9px;font-size:.85rem;font-weight:600;color:var(--muted);cursor:pointer;transition:all .18s;margin-bottom:2px;border:none;background:none;width:100%;text-align:left}
.nav-item i{width:18px;text-align:center;font-size:.88rem;flex-shrink:0}
.nav-item:hover{background:rgba(255,255,255,.05);color:var(--text)}
.nav-item.active{background:rgba(99,102,241,.15);color:#a5b4fc}
.nav-item.active i{color:var(--p)}
.nav-badge{margin-left:auto;background:var(--warning);color:#000;font-size:.6rem;font-weight:800;padding:2px 6px;border-radius:10px;min-width:18px;text-align:center}
.sb-footer{padding:12px 10px;border-top:1px solid var(--border)}
.sb-logout{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:9px;font-size:.85rem;font-weight:600;color:var(--danger);cursor:pointer;transition:background .18s;border:none;background:none;width:100%}
.sb-logout:hover{background:rgba(239,68,68,.08)}
.sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:199}

/* TOPBAR */
.topbar{display:none;position:fixed;top:0;left:0;right:0;height:56px;background:var(--card);border-bottom:1px solid var(--border);align-items:center;padding:0 16px;gap:12px;z-index:150}
.topbar-menu{background:none;border:none;color:var(--text);font-size:1.1rem;cursor:pointer;padding:6px}
.topbar-logo{font-size:1rem;font-weight:800;background:linear-gradient(135deg,#818cf8,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;flex:1}
.topbar-badge{background:rgba(99,102,241,.2);border:1px solid rgba(99,102,241,.3);color:#a5b4fc;font-size:.68rem;font-weight:700;padding:3px 8px;border-radius:6px}

/* MAIN */
.main{margin-left:240px;min-height:100vh;display:flex;flex-direction:column}
.page-header{padding:26px 26px 0;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.page-title{font-size:1.25rem;display:flex;align-items:center;gap:10px}
.page-title i{color:var(--p)}
.page-subtitle{color:var(--muted);font-size:.8rem;font-weight:400;margin-top:3px;margin-left:28px}
.content{padding:20px 26px 40px;flex:1}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px;margin-bottom:22px}
.stat-card{background:var(--card2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s;cursor:default}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;opacity:0;transition:opacity .2s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.stat-card:hover::before{opacity:1}
.sc-purple::before{background:linear-gradient(90deg,var(--p),var(--p2))}
.sc-green::before{background:linear-gradient(90deg,#10b981,#34d399)}
.sc-blue::before{background:linear-gradient(90deg,#3b82f6,#60a5fa)}
.sc-yellow::before{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.stat-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:.95rem;margin-bottom:14px}
.si-p{background:rgba(99,102,241,.15);color:#a5b4fc}
.si-g{background:rgba(16,185,129,.12);color:#34d399}
.si-b{background:rgba(59,130,246,.12);color:#60a5fa}
.si-y{background:rgba(245,158,11,.12);color:#fbbf24}
.stat-label{font-size:.68rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.stat-value{font-size:1.7rem;font-weight:800;letter-spacing:-.04em;line-height:1}
.sv-p{color:#a5b4fc}.sv-g{color:#34d399}.sv-b{color:#60a5fa}.sv-y{color:#fbbf24}

/* PANEL */
.panel{background:var(--card2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.panel-body{padding:0}

/* TABLE */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:500px}
thead{background:rgba(255,255,255,.02)}
th{padding:12px 16px;text-align:left;font-size:.68rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:12px 16px;border-bottom:1px solid var(--border2);vertical-align:middle;font-size:.84rem}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover td{background:rgba(255,255,255,.02)}

/* MOBILE CARDS */
.card-list{display:none;padding:10px}
.m-card{background:var(--card3);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.m-card:last-child{margin-bottom:0}
.m-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px;flex-wrap:wrap}
.m-card-title{font-weight:700;font-size:.86rem;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.m-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.mf label{font-size:.63rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:2px}
.mf span{font-size:.82rem}
.m-actions{display:flex;flex-wrap:wrap;gap:7px;margin-top:12px}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap}
.b-admin{background:rgba(250,204,21,.15);color:#fde047;border:1px solid rgba(250,204,21,.2)}
.b-user{background:rgba(99,102,241,.15);color:#a5b4fc;border:1px solid rgba(99,102,241,.2)}
.sbadge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap}
.s-pend{background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.2)}
.s-proc{background:rgba(59,130,246,.15);color:#60a5fa;border:1px solid rgba(59,130,246,.2)}
.s-deliv{background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.2)}
.s-canc{background:rgba(239,68,68,.15);color:#f87171;border:1px solid rgba(239,68,68,.2)}
.type-chip{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.68rem;font-weight:700;white-space:nowrap}
.tc-dc{background:rgba(59,130,246,.12);color:#60a5fa}
.tc-res{background:rgba(16,185,129,.12);color:#34d399}
.tc-resp{background:rgba(139,92,246,.12);color:#c084fc}
.tc-isp{background:rgba(6,182,212,.12);color:#22d3ee}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 13px;border-radius:7px;border:none;font-size:.8rem;font-weight:700;cursor:pointer;transition:all .18s;white-space:nowrap;font-family:inherit}
.btn-p{background:linear-gradient(135deg,var(--p),var(--p2));color:white}
.btn-p:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 12px rgba(99,102,241,.35)}
.btn-s{background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.25)}
.btn-s:hover{background:rgba(16,185,129,.25)}
.btn-d{background:rgba(239,68,68,.12);color:#f87171;border:1px solid rgba(239,68,68,.2)}
.btn-d:hover{background:rgba(239,68,68,.2)}
.btn-w{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.2)}
.btn-w:hover{background:rgba(245,158,11,.22)}
.btn-ghost{background:rgba(255,255,255,.05);color:var(--muted);border:1px solid var(--border)}
.btn-ghost:hover{background:rgba(255,255,255,.1);color:var(--text)}
.btn-sm{padding:5px 9px;font-size:.73rem}
.refresh-btn{display:inline-flex;align-items:center;gap:7px;background:var(--p3);border:1px solid rgba(99,102,241,.25);color:#a5b4fc;padding:7px 13px;border-radius:8px;font-size:.8rem;font-weight:700;cursor:pointer;transition:background .2s;font-family:inherit}
.refresh-btn:hover{background:rgba(99,102,241,.25)}

/* MISC */
.balp{display:inline-flex;align-items:center;gap:4px;background:rgba(16,185,129,.1);color:#34d399;border:1px solid rgba(16,185,129,.2);border-radius:7px;padding:3px 8px;font-size:.8rem;font-weight:700}
.email-cell{display:flex;align-items:center;gap:9px}
.eavatar{width:27px;height:27px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--p2));display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;flex-shrink:0}
.notes-cell{max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--muted);font-size:.76rem}
.empty-state{padding:46px 20px;text-align:center;color:var(--muted)}
.empty-state i{font-size:1.8rem;opacity:.3;display:block;margin-bottom:10px}
.empty-state p{font-size:.84rem}
.spin-wrap{padding:38px;text-align:center;color:var(--muted)}
.spin{display:inline-block;width:22px;height:22px;border:2.5px solid rgba(255,255,255,.1);border-top-color:var(--p);border-radius:50%;animation:rot .8s linear infinite;vertical-align:middle}
@keyframes rot{to{transform:rotate(360deg)}}

/* ALERTS */
.alert{padding:10px 13px;border-radius:8px;font-size:.82rem;margin-bottom:13px;display:flex;align-items:center;gap:8px}
.al-s{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);color:#34d399}
.al-e{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);color:#f87171}

/* MODAL */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:500;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(3px)}
.modal.open{display:flex}
.modal-box{background:var(--card2);border:1px solid var(--border);border-radius:18px;padding:26px;width:100%;max-width:460px;max-height:92vh;overflow-y:auto;box-shadow:0 40px 80px rgba(0,0,0,.6)}
.modal-box.wide{max-width:540px}
.modal-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.modal-top h2{font-size:1.02rem;display:flex;align-items:center;gap:9px}
.modal-top h2 i{color:var(--p)}
.mclose{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text);width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:.88rem;display:flex;align-items:center;justify-content:center;transition:background .2s;flex-shrink:0}
.mclose:hover{background:rgba(255,255,255,.12)}
.modal-sub{color:var(--muted);font-size:.81rem;margin:-12px 0 18px 4px}
.modal-foot{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;flex-wrap:wrap}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;padding:12px 16px;border-radius:10px;font-size:.82rem;font-weight:600;z-index:9999;display:flex;align-items:center;gap:8px;transform:translateY(80px);opacity:0;transition:all .3s ease;max-width:320px;pointer-events:none;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.toast.show{transform:translateY(0);opacity:1}
.t-ok{background:rgba(16,185,129,.2);border:1px solid rgba(16,185,129,.35);color:#34d399}
.t-err{background:rgba(239,68,68,.2);border:1px solid rgba(239,68,68,.35);color:#f87171}

/* RESPONSIVE */
@media(max-width:768px){
    .sidebar{transform:translateX(-100%)}
    .sidebar.open{transform:translateX(0)}
    .sb-overlay.open{display:block}
    .topbar{display:flex}
    .main{margin-left:0;padding-top:56px}
    .content{padding:14px 12px 40px}
    .page-header{padding:14px 12px 0}
    .page-title{font-size:1.05rem}
    .stats-grid{grid-template-columns:1fr 1fr;gap:10px}
    .stat-value{font-size:1.4rem}
    table{display:none}
    .card-list{display:block}
    .modal-box{padding:18px 16px}
    .modal-foot{justify-content:stretch}
    .modal-foot .btn{flex:1;justify-content:center}
}
@media(max-width:380px){
    .stats-grid{grid-template-columns:1fr}
    .login-box{padding:24px 18px}
    .m-grid{grid-template-columns:1fr}
}
    </style>
</head>
<body>

<div class="toast" id="toast"><i id="ti"></i><span id="tm"></span></div>

<!-- LOGIN -->
<div id="loginScreen">
    <div class="login-box">
        <div class="login-icon">üëë</div>
        <h1 class="login-title">Admin Panel</h1>
        <p class="login-sub">ProxyFlow ‚Äî Espace administration</p>
        <div id="loginAlert"></div>
        <form id="loginForm">
            <div class="fg">
                <label class="fl">Email</label>
                <input class="fi" type="email" id="loginEmail" required placeholder="admin@proxyflow.com">
            </div>
            <div class="fg">
                <label class="fl">Mot de passe</label>
                <input class="fi" type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button type="submit" class="btn-login" id="loginBtn">Se connecter</button>
        </form>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <!-- Mobile topbar -->
    <div class="topbar">
        <button class="topbar-menu" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <span class="topbar-logo">ProxyFlow</span>
        <span class="topbar-badge">ADMIN</span>
    </div>
    <div class="sb-overlay" id="sbOverlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sb-logo">
            <div class="sb-logo-icon">üåê</div>
            <div><div class="sb-logo-text">ProxyFlow</div><span class="sb-logo-badge">ADMIN</span></div>
        </div>
        <div class="sb-admin">
            <div class="sb-avatar" id="sbAvatarChar">A</div>
            <div class="sb-admin-info">
                <div class="sb-admin-label">Connect√© en tant que</div>
                <div class="sb-admin-email" id="adminEmail">‚Äî</div>
            </div>
        </div>
        <nav class="sb-nav">
            <div class="sb-sec-label">Navigation</div>
            <button class="nav-item active" onclick="switchTab('users',this)"><i class="fas fa-users"></i> Utilisateurs</button>
            <button class="nav-item" onclick="switchTab('transactions',this)"><i class="fas fa-exchange-alt"></i> Transactions</button>
            <button class="nav-item" onclick="switchTab('recharges',this)"><i class="fas fa-credit-card"></i> Recharges</button>
            <button class="nav-item" id="navOrders" onclick="switchTab('manualOrders',this)">
                <i class="fas fa-box"></i> Commandes
                <span class="nav-badge" id="navBadge" style="display:none">0</span>
            </button>
        </nav>
        <div class="sb-footer">
            <button class="sb-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">

        <!-- USERS TAB -->
        <div id="tab-users" class="tab-content" style="display:block">
            <div class="page-header">
                <div>
                    <div class="page-title"><i class="fas fa-users"></i> Utilisateurs</div>
                    <div class="page-subtitle">Gestion des comptes et balances</div>
                </div>
                <button class="refresh-btn" onclick="loadUsers()"><i class="fas fa-sync-alt"></i> Actualiser</button>
            </div>
            <div class="content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card sc-purple">
                        <div class="stat-icon si-p"><i class="fas fa-users"></i></div>
                        <div class="stat-label">Utilisateurs</div>
                        <div class="stat-value sv-p" id="totalUsers">‚Äî</div>
                    </div>
                    <div class="stat-card sc-green">
                        <div class="stat-icon si-g"><i class="fas fa-network-wired"></i></div>
                        <div class="stat-label">Proxies vendus</div>
                        <div class="stat-value sv-g" id="totalProxies">‚Äî</div>
                    </div>
                    <div class="stat-card sc-blue">
                        <div class="stat-icon si-b"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-label">Revenus</div>
                        <div class="stat-value sv-b" id="totalRevenue">‚Äî</div>
                    </div>
                    <div class="stat-card sc-yellow">
                        <div class="stat-icon si-y"><i class="fas fa-clock"></i></div>
                        <div class="stat-label">Commandes en attente</div>
                        <div class="stat-value sv-y" id="pendingOrders">‚Äî</div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-body">
                        <div class="spin-wrap" id="usersLoading"><span class="spin"></span></div>
                        <div class="table-wrap">
                            <table id="usersTable" style="display:none">
                                <thead><tr><th>Utilisateur</th><th>Balance</th><th>R√¥le</th><th>Inscription</th><th>Actions</th></tr></thead>
                                <tbody id="usersBody"></tbody>
                            </table>
                        </div>
                        <div class="card-list" id="usersCards"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TRANSACTIONS TAB -->
        <div id="tab-transactions" class="tab-content" style="display:none">
            <div class="page-header">
                <div><div class="page-title"><i class="fas fa-exchange-alt"></i> Transactions</div></div>
            </div>
            <div class="content">
                <div class="panel"><div class="empty-state"><i class="fas fa-chart-bar"></i><p>Module transactions √† venir</p></div></div>
            </div>
        </div>

        <!-- RECHARGES TAB -->
        <div id="tab-recharges" class="tab-content" style="display:none">
            <div class="page-header">
                <div>
                    <div class="page-title"><i class="fas fa-credit-card"></i> Recharges</div>
                    <div class="page-subtitle">Demandes de recharge en attente</div>
                </div>
                <button class="refresh-btn" onclick="loadRecharges()"><i class="fas fa-sync-alt"></i> Actualiser</button>
            </div>
            <div class="content">
                <div class="panel"><div class="panel-body">
                    <div class="spin-wrap" id="rechargesLoading"><span class="spin"></span></div>
                    <div class="table-wrap">
                        <table id="rechargesTable" style="display:none">
                            <thead><tr><th>Utilisateur</th><th>FaucetPay</th><th>Montant</th><th>Date</th><th>Statut</th><th>Actions</th></tr></thead>
                            <tbody id="rechargesBody"></tbody>
                        </table>
                    </div>
                    <div class="card-list" id="rechargesCards"></div>
                </div></div>
            </div>
        </div>

        <!-- MANUAL ORDERS TAB -->
        <div id="tab-manualOrders" class="tab-content" style="display:none">
            <div class="page-header">
                <div>
                    <div class="page-title"><i class="fas fa-box"></i> Commandes Manuelles</div>
                    <div class="page-subtitle">Traitement et livraison des commandes</div>
                </div>
                <button class="refresh-btn" onclick="loadManualOrders()"><i class="fas fa-sync-alt"></i> Actualiser</button>
            </div>
            <div class="content">
                <div class="panel"><div class="panel-body">
                    <div class="spin-wrap" id="ordersLoading"><span class="spin"></span></div>
                    <div class="table-wrap">
                        <table id="ordersTable" style="display:none">
                            <thead><tr><th>Client</th><th>Type</th><th>Volume</th><th>Prix</th><th>Date</th><th>Notes</th><th>Statut</th><th>Actions</th></tr></thead>
                            <tbody id="ordersBody"></tbody>
                        </table>
                    </div>
                    <div class="card-list" id="ordersCards"></div>
                </div></div>
            </div>
        </div>

    </main>
</div>

<!-- CREDIT MODAL -->
<div class="modal" id="creditModal">
    <div class="modal-box">
        <div class="modal-top">
            <h2><i class="fas fa-coins"></i> Ajouter du cr√©dit</h2>
            <button class="mclose" onclick="closeCreditModal()"><i class="fas fa-times"></i></button>
        </div>
        <div id="creditAlert"></div>
        <form id="creditForm">
            <input type="hidden" id="creditUserId">
            <div class="fg"><label class="fl">Utilisateur</label><input class="fi" type="text" id="creditUserEmail" readonly></div>
            <div class="fg"><label class="fl">Montant ($)</label><input class="fi" type="number" id="creditAmount" step="0.01" min="0.01" required placeholder="0.00"></div>
            <div class="fg"><label class="fl">Description <small style="font-weight:400;text-transform:none;color:var(--muted2)">(optionnel)</small></label>
                <textarea class="ft" id="creditDescription" rows="2" placeholder="Ex: Recharge manuelle..."></textarea></div>
            <div class="modal-foot">
                <button type="button" class="btn btn-ghost" onclick="closeCreditModal()">Annuler</button>
                <button type="submit" class="btn btn-s"><i class="fas fa-check"></i> Ajouter</button>
            </div>
        </form>
    </div>
</div>

<!-- DELIVER MODAL -->
<div class="modal" id="deliverModal">
    <div class="modal-box wide">
        <div class="modal-top">
            <h2><i class="fas fa-truck"></i> Livrer la commande</h2>
            <button class="mclose" onclick="closeDeliverModal()"><i class="fas fa-times"></i></button>
        </div>
        <p class="modal-sub">Collez les credentials √† transmettre (ip:port:user:pass ou texte libre)</p>
        <div id="deliverAlert"></div>
        <input type="hidden" id="deliverOrderId">
        <div class="fg">
            <label class="fl">Informations de livraison</label>
            <textarea class="ft" id="deliveryNotes" rows="5" placeholder="1.2.3.4:8080:user:pass&#10;ou&#10;host: proxy.example.com&#10;port: 8080&#10;user: john&#10;pass: secret123"></textarea>
        </div>
        <div class="modal-foot">
            <button type="button" class="btn btn-ghost" onclick="closeDeliverModal()">Annuler</button>
            <button type="button" class="btn btn-s" onclick="confirmDeliver()"><i class="fas fa-paper-plane"></i> Livrer</button>
        </div>
    </div>
</div>

<script>
let token = localStorage.getItem('adminToken');
let currentUser = null;

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
function toast(msg, type='ok') {
    const el = document.getElementById('toast');
    document.getElementById('ti').className = type === 'ok' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    document.getElementById('tm').textContent = msg;
    el.className = 'toast t-' + type + ' show';
    setTimeout(() => el.className = 'toast t-' + type, 3200);
}
function showAlert(elId, msg, type) {
    document.getElementById(elId).innerHTML = `<div class="alert al-${type==='success'?'s':'e'}"><i class="fas fa-${type==='success'?'check':'exclamation'}-circle"></i>${msg}</div>`;
}
function esc(s) { return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

/* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sbOverlay').classList.toggle('open');
}

/* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
function switchTab(name, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('tab-' + name).style.display = 'block';
    if (btn) btn.classList.add('active');
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sbOverlay').classList.remove('open');
    if (name === 'recharges') loadRecharges();
    if (name === 'manualOrders') loadManualOrders();
}

/* ‚îÄ‚îÄ Auth ‚îÄ‚îÄ */
document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    btn.textContent = '...'; btn.disabled = true;
    try {
        const res = await fetch('/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email: document.getElementById('loginEmail').value, password: document.getElementById('loginPassword').value }) });
        const data = await res.json();
        if (!res.ok) { showAlert('loginAlert', data.error || 'Erreur de connexion', 'error'); return; }
        if (!data.user.isAdmin) { showAlert('loginAlert', 'Acc√®s refus√© ‚Äî Admin requis', 'error'); return; }
        token = data.token; localStorage.setItem('adminToken', token); currentUser = data.user; showDashboard();
    } catch(err) { showAlert('loginAlert', 'Erreur: ' + err.message, 'error'); }
    finally { btn.textContent = 'Se connecter'; btn.disabled = false; }
});

function logout() { localStorage.removeItem('adminToken'); token = null; currentUser = null; document.getElementById('dashboard').style.display = 'none'; document.getElementById('loginScreen').style.display = 'flex'; }

async function showDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    const email = currentUser.email;
    document.getElementById('adminEmail').textContent = email;
    document.getElementById('sbAvatarChar').textContent = email.charAt(0).toUpperCase();
    await loadStats(); await loadUsers(); await loadManualOrders();
}

/* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
async function loadStats() {
    try {
        const res = await fetch('/api/admin/stats', { headers: {'Authorization': `Bearer ${token}`} });
        const d = await res.json();
        document.getElementById('totalUsers').textContent = d.totalUsers || 0;
        document.getElementById('totalProxies').textContent = d.totalProxies || 0;
        document.getElementById('totalRevenue').textContent = '$' + (d.totalRevenue || 0).toFixed(2);
    } catch(e) {}
}

/* ‚îÄ‚îÄ Users ‚îÄ‚îÄ */
async function loadUsers() {
    document.getElementById('usersLoading').style.display = 'block';
    document.getElementById('usersTable').style.display = 'none';
    document.getElementById('usersCards').innerHTML = '';
    try {
        const users = await (await fetch('/api/admin/users', { headers: {'Authorization': `Bearer ${token}`} })).json();
        document.getElementById('usersLoading').style.display = 'none';
        document.getElementById('usersTable').style.display = 'table';
        document.getElementById('usersBody').innerHTML = users.map(u => `
            <tr>
                <td><div class="email-cell"><div class="eavatar">${u.email.charAt(0).toUpperCase()}</div><span>${esc(u.email)}</span></div></td>
                <td><span class="balp"><i class="fas fa-dollar-sign" style="font-size:.65rem"></i>${u.balance.toFixed(2)}</span></td>
                <td><span class="badge ${u.isAdmin?'b-admin':'b-user'}">${u.isAdmin?'üëë Admin':'User'}</span></td>
                <td style="color:var(--muted);font-size:.76rem">${new Date(u.createdAt).toLocaleDateString('fr-FR')}</td>
                <td><div style="display:flex;gap:5px;flex-wrap:wrap">
                    <button class="btn btn-sm btn-s" onclick="openCreditModal('${u._id}','${esc(u.email)}')"><i class="fas fa-plus"></i> Cr√©dit</button>
                    ${!u.isAdmin?`<button class="btn btn-sm btn-w" onclick="promoteUser('${u._id}')"><i class="fas fa-crown"></i> Promouvoir</button>`:''}
                </div></td>
            </tr>`).join('') || '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-users"></i><p>Aucun utilisateur</p></div></td></tr>';
        document.getElementById('usersCards').innerHTML = users.map(u => `
            <div class="m-card">
                <div class="m-card-top">
                    <div class="email-cell" style="min-width:0;flex:1"><div class="eavatar">${u.email.charAt(0).toUpperCase()}</div><span class="m-card-title">${esc(u.email)}</span></div>
                    <span class="badge ${u.isAdmin?'b-admin':'b-user'}">${u.isAdmin?'üëë Admin':'User'}</span>
                </div>
                <div class="m-grid">
                    <div class="mf"><label>Balance</label><span class="balp"><i class="fas fa-dollar-sign" style="font-size:.65rem"></i>${u.balance.toFixed(2)}</span></div>
                    <div class="mf"><label>Inscription</label><span>${new Date(u.createdAt).toLocaleDateString('fr-FR')}</span></div>
                </div>
                <div class="m-actions">
                    <button class="btn btn-sm btn-s" onclick="openCreditModal('${u._id}','${esc(u.email)}')"><i class="fas fa-plus"></i> Cr√©dit</button>
                    ${!u.isAdmin?`<button class="btn btn-sm btn-w" onclick="promoteUser('${u._id}')"><i class="fas fa-crown"></i> Promouvoir</button>`:''}
                </div>
            </div>`).join('') || '<div class="empty-state"><i class="fas fa-users"></i><p>Aucun utilisateur</p></div>';
    } catch(e) { console.error(e); }
}

/* ‚îÄ‚îÄ Recharges ‚îÄ‚îÄ */
async function loadRecharges() {
    document.getElementById('rechargesLoading').style.display = 'block';
    document.getElementById('rechargesTable').style.display = 'none';
    document.getElementById('rechargesCards').innerHTML = '';
    try {
        const list = await (await fetch('/api/admin/recharges', { headers: {'Authorization': `Bearer ${token}`} })).json();
        document.getElementById('rechargesLoading').style.display = 'none';
        document.getElementById('rechargesTable').style.display = 'table';
        const SC = { pending:'s-pend', approved:'s-deliv', rejected:'s-canc' };
        document.getElementById('rechargesBody').innerHTML = list.map(r => `
            <tr>
                <td>${esc(r.userEmail)}</td>
                <td><code style="font-size:.76rem;color:var(--muted)">${esc(r.faucetpayUsername)}</code></td>
                <td><span class="balp">$${r.amount.toFixed(2)}</span></td>
                <td style="color:var(--muted);font-size:.75rem">${new Date(r.createdAt).toLocaleString('fr-FR')}</td>
                <td><span class="sbadge ${SC[r.status]||'s-pend'}">${r.status}</span></td>
                <td>${r.status==='pending'?`<div style="display:flex;gap:5px"><button class="btn btn-sm btn-s" onclick="validateRecharge('${r._id}')"><i class="fas fa-check"></i> Valider</button><button class="btn btn-sm btn-d" onclick="rejectRecharge('${r._id}')"><i class="fas fa-times"></i></button></div>`:' <span style="color:var(--muted)">‚Äî</span>'}</td>
            </tr>`).join('') || '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-credit-card"></i><p>Aucune recharge</p></div></td></tr>';
        document.getElementById('rechargesCards').innerHTML = list.map(r => `
            <div class="m-card">
                <div class="m-card-top"><span class="m-card-title">${esc(r.userEmail)}</span><span class="sbadge ${SC[r.status]||'s-pend'}">${r.status}</span></div>
                <div class="m-grid">
                    <div class="mf"><label>FaucetPay</label><span>${esc(r.faucetpayUsername)}</span></div>
                    <div class="mf"><label>Montant</label><span class="balp">$${r.amount.toFixed(2)}</span></div>
                    <div class="mf"><label>Date</label><span>${new Date(r.createdAt).toLocaleDateString('fr-FR')}</span></div>
                </div>
                ${r.status==='pending'?`<div class="m-actions"><button class="btn btn-sm btn-s" onclick="validateRecharge('${r._id}')"><i class="fas fa-check"></i> Valider</button><button class="btn btn-sm btn-d" onclick="rejectRecharge('${r._id}')"><i class="fas fa-times"></i> Rejeter</button></div>`:''}
            </div>`).join('') || '<div class="empty-state"><i class="fas fa-credit-card"></i><p>Aucune recharge</p></div>';
    } catch(e) { console.error(e); }
}
async function validateRecharge(id) { if(!confirm('Valider ?')) return; await fetch(`/api/admin/recharges/${id}/approve`,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}}); toast('Recharge valid√©e ‚úì'); loadRecharges(); loadUsers(); loadStats(); }
async function rejectRecharge(id) { if(!confirm('Rejeter ?')) return; await fetch(`/api/admin/recharges/${id}/reject`,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}}); toast('Recharge rejet√©e','err'); loadRecharges(); }

/* ‚îÄ‚îÄ Manual Orders ‚îÄ‚îÄ */
const TC = {datacenter:'tc-dc',residential:'tc-res',residential_pro:'tc-resp',static_isp:'tc-isp'};
const SL = {pending:'En attente',processing:'En cours',delivered:'Livr√©',cancelled:'Annul√©'};
const SC = {pending:'s-pend',processing:'s-proc',delivered:'s-deliv',cancelled:'s-canc'};
function ordActions(o) {
    if(o.status==='pending') return `<div style="display:flex;gap:5px;flex-wrap:wrap"><button class="btn btn-sm btn-w" onclick="markProcessing('${o._id}')"><i class="fas fa-cog"></i> En cours</button><button class="btn btn-sm btn-s" onclick="openDeliverModal('${o._id}')"><i class="fas fa-truck"></i> Livrer</button><button class="btn btn-sm btn-d" onclick="cancelOrder('${o._id}')"><i class="fas fa-times"></i></button></div>`;
    if(o.status==='processing') return `<div style="display:flex;gap:5px;flex-wrap:wrap"><button class="btn btn-sm btn-s" onclick="openDeliverModal('${o._id}')"><i class="fas fa-truck"></i> Livrer</button><button class="btn btn-sm btn-d" onclick="cancelOrder('${o._id}')"><i class="fas fa-times"></i></button></div>`;
    return `<span style="color:var(--muted);font-size:.74rem">‚Äî</span>`;
}
async function loadManualOrders() {
    document.getElementById('ordersLoading').style.display = 'block';
    document.getElementById('ordersTable').style.display = 'none';
    document.getElementById('ordersCards').innerHTML = '';
    try {
        const orders = await (await fetch('/api/admin/manual-orders', { headers:{'Authorization':`Bearer ${token}`} })).json();
        document.getElementById('ordersLoading').style.display = 'none';
        document.getElementById('ordersTable').style.display = 'table';
        const pend = orders.filter(o=>o.status==='pending').length;
        document.getElementById('navBadge').textContent = pend;
        document.getElementById('navBadge').style.display = pend > 0 ? 'inline' : 'none';
        document.getElementById('pendingOrders').textContent = pend;
        if(!orders.length) {
            document.getElementById('ordersBody').innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-box-open"></i><p>Aucune commande</p></div></td></tr>';
            document.getElementById('ordersCards').innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><p>Aucune commande manuelle</p></div>';
            return;
        }
        document.getElementById('ordersBody').innerHTML = orders.map(o => `
            <tr>
                <td><div class="email-cell"><div class="eavatar">${(o.userEmail||'?').charAt(0).toUpperCase()}</div><span style="font-size:.82rem">${esc(o.userEmail)}</span></div></td>
                <td><span class="type-chip ${TC[o.type]||''}">${esc(o.typeLabel||o.type)}</span></td>
                <td style="font-weight:700">${esc(o.volume)}</td>
                <td><span class="balp">$${o.totalPrice.toFixed(2)}</span></td>
                <td style="color:var(--muted);font-size:.73rem">${new Date(o.createdAt).toLocaleString('fr-FR')}</td>
                <td><div class="notes-cell" title="${esc(o.notes||'')}">${esc(o.notes||'‚Äî')}</div></td>
                <td><span class="sbadge ${SC[o.status]||''}">${SL[o.status]||o.status}</span></td>
                <td>${ordActions(o)}</td>
            </tr>`).join('');
        document.getElementById('ordersCards').innerHTML = orders.map(o => `
            <div class="m-card">
                <div class="m-card-top"><span class="m-card-title">${esc(o.userEmail)}</span><span class="sbadge ${SC[o.status]||''}">${SL[o.status]||o.status}</span></div>
                <div class="m-grid">
                    <div class="mf"><label>Type</label><span class="type-chip ${TC[o.type]||''}">${esc(o.typeLabel||o.type)}</span></div>
                    <div class="mf"><label>Volume</label><span style="font-weight:700">${esc(o.volume)}</span></div>
                    <div class="mf"><label>Prix</label><span class="balp">$${o.totalPrice.toFixed(2)}</span></div>
                    <div class="mf"><label>Date</label><span style="font-size:.74rem">${new Date(o.createdAt).toLocaleDateString('fr-FR')}</span></div>
                    ${o.notes?`<div class="mf" style="grid-column:1/-1"><label>Notes</label><span style="font-size:.76rem;color:var(--muted)">${esc(o.notes)}</span></div>`:''}
                </div>
                <div class="m-actions">${ordActions(o)}</div>
            </div>`).join('');
    } catch(e) { console.error(e); }
}
async function markProcessing(id) { const res = await fetch('/api/admin/manual-orders/'+id+'/processing',{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}}); if(!res.ok){toast((await res.json()).error||'Erreur','err');return;} toast('En cours ‚öôÔ∏è'); loadManualOrders(); }
async function cancelOrder(id) { if(!confirm('Annuler et rembourser ?')) return; const res = await fetch('/api/admin/manual-orders/'+id+'/cancel',{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}}); const d = await res.json(); if(!res.ok){toast(d.error||'Erreur','err');return;} toast('Annul√© ‚Äî client rembours√©'); loadManualOrders(); loadUsers(); }

/* ‚îÄ‚îÄ Credit modal ‚îÄ‚îÄ */
function openCreditModal(id, email) { document.getElementById('creditUserId').value=id; document.getElementById('creditUserEmail').value=email; document.getElementById('creditAmount').value=''; document.getElementById('creditDescription').value=''; document.getElementById('creditAlert').innerHTML=''; document.getElementById('creditModal').classList.add('open'); }
function closeCreditModal() { document.getElementById('creditModal').classList.remove('open'); }
document.getElementById('creditForm').addEventListener('submit', async e => {
    e.preventDefault();
    const res = await fetch('/api/admin/add-credit',{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify({userId:document.getElementById('creditUserId').value,amount:parseFloat(document.getElementById('creditAmount').value),description:document.getElementById('creditDescription').value})});
    const data = await res.json();
    if(!res.ok){showAlert('creditAlert',data.error||'Erreur','error');return;}
    showAlert('creditAlert','‚úÖ Cr√©dit ajout√© !','success');
    setTimeout(()=>{closeCreditModal();loadUsers();loadStats();toast('Cr√©dit ajout√© ‚úì');},1100);
});

/* ‚îÄ‚îÄ Deliver modal ‚îÄ‚îÄ */
function openDeliverModal(id) { document.getElementById('deliverOrderId').value=id; document.getElementById('deliveryNotes').value=''; document.getElementById('deliverAlert').innerHTML=''; document.getElementById('deliverModal').classList.add('open'); }
function closeDeliverModal() { document.getElementById('deliverModal').classList.remove('open'); }
async function confirmDeliver() {
    const notes = document.getElementById('deliveryNotes').value.trim();
    if(!notes){showAlert('deliverAlert','Informations de livraison requises','error');return;}
    const res = await fetch('/api/admin/manual-orders/'+document.getElementById('deliverOrderId').value+'/deliver',{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify({deliveryNotes:notes})});
    const data = await res.json();
    if(!res.ok){showAlert('deliverAlert',data.error||'Erreur','error');return;}
    showAlert('deliverAlert','‚úÖ Livraison enregistr√©e !','success');
    setTimeout(()=>{closeDeliverModal();loadManualOrders();toast('Commande livr√©e üì¶');},1000);
}

async function promoteUser(id) { if(!confirm('Promouvoir en admin ?')) return; await fetch('/api/admin/promote',{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify({userId:id})}); toast('Promu admin üëë'); loadUsers(); }

/* ‚îÄ‚îÄ Close modal on backdrop ‚îÄ‚îÄ */
document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if(e.target===m) m.classList.remove('open'); }));

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
if(token){fetch('/api/auth/me',{headers:{'Authorization':`Bearer ${token}`}}).then(r=>r.json()).then(u=>{if(u.isAdmin){currentUser=u;showDashboard();}else logout();}).catch(logout);}
</script>
</body>
</html>
